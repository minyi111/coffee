<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>‚òï Global Coffee Insight Map</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://js.arcgis.com/4.28/"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", sans-serif;
      background-color: #1f1f1f;
      color: white;
    }
    .container {
      display: flex;
      height: 100%;
    }
    #left-panel {
      width: 250px;
      background: #2a2a2a;
      padding: 16px;
    }
    #map {
      flex: 1;
      height: 100%;
    }
    #right-panel {
      width: 360px;
      background: #2a2a2a;
      padding: 16px;
      overflow-y: auto;
    }
    canvas {
      margin-top: 16px;
      background-color: #1f1f1f;
    }
    select, button {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #444;
      color: white;
    }
    .chart-title {
      font-size: 16px;
      color: #8a2be2;
      margin-top: 10px;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- üìÖ Â∑¶‰æßÊéßÂà∂Èù¢Êùø -->
  <div id="left-panel">
    <h2>‚òï Coffee Map</h2>
    <button onclick="loadWebMap('909ccff2f308451ca3d47aa968928a3b',[103.8, 1.35], 13)">Coffee Shop location in SG</button>
    <button onclick="loadWebMap('7a7a761019c744af8fe5a4315c3a1da2', [0, 20], 2)">Google Trends Map</button>
    <!-- üìà ÂìÅÁâåÁÉ≠Â∫¶ÂõæÂ±ÇÂàáÊç¢ -->
    <div id="trend-controls">
      <button onclick="showBrandTrends('StarbucksTrends')">Starbucks</button>
      <button onclick="showBrandTrends('TimsTrends')">Tim Hortons</button>
      <button onclick="showBrandTrends('LuckinTrends')">Luckin Coffee</button>
    </div>
  </div>

  <!-- üåç Âú∞ÂõæÂå∫Âüü -->
  <div id="map"></div>

  <!-- üî¢ Âè≥‰æßÂõæË°®Èù¢Êùø -->
  <div id="right-panel">
    <div class="chart-title">üî• Global Search Trends</div>
    <canvas id="pieChart" height="200"></canvas>
  </div>
</div>

<script>
  let view;

  // ‚òï Âä†ËΩΩ Web Map
  function loadWebMap(mapId, center = [0, 20], zoom = 2) {
    require(["esri/WebMap", "esri/views/MapView"], (WebMap, MapView) => {
      if (view) {
        view.container = null;
        view.destroy();
      }
      const webmap = new WebMap({ portalItem: { id: mapId } });
      view = new MapView({ container: "map", map: webmap, center, zoom });
      enablePopupToSidebar(view);
    });
  }

  // ‚òï Â±ïÁ§∫ popup ÂÜÖÂÆπÂà∞Âè≥‰æßÈù¢Êùø
  function enablePopupToSidebar(view) {
    const brandLinks = { /* Áï•Ôºö‰Ω†Êèê‰æõÁöÑÈìæÊé• */ };
    view.popup.autoOpenEnabled = false;
    view.on("click", (event) => {
      view.hitTest(event).then((response) => {
        const result = response.results.find(res => res.graphic.layer.title === "Chain_CoffeeShop" || res.graphic.layer.title === "independent_coffee_by_region");
        if (result) {
          const attr = result.graphic.attributes;
          const brand = attr.Brand;
          const shopType = result.graphic.layer.title === "Chain_CoffeeShop" ? "Chain Coffee Shop" : "Independent Coffee Shop";
          const link = brandLinks[brand];

          let html = `<div style="font-size:15px; padding:10px; line-height:1.6;">
            <div style="font-size:18px; font-weight:bold; margin-bottom:10px;">‚òï ${shopType}</div>
            <strong>Name:</strong> ${attr.Name}<br>
            <strong>Address:</strong> ${attr.Address}<br>
            <strong>Rating:</strong> ${attr.Rating} ‚≠ê<br><br>`;

          if (link) {
            const isApp = link.includes("app") || link.includes("download");
            const label = isApp ? "Download App to Order" : "Order Online";
            html += `<a href="${link}" target="_blank"><button style="background-color:#8a2be2;border:none;color:white;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">${label}</button></a>`;
          }
          html += `</div>`;
          document.getElementById("right-panel").innerHTML = html;
        }
      });
    });
  }

  // üåê Google Trends ÂÖ®ÁêÉÁÉ≠Â∫¶ÂàÜÂ∏É Pie Chart
  function showBrandTrends(layerTitle) {
    view.map.layers.forEach(layer => {
      if (["StarbucksTrends", "TimsTrends", "LuckinTrends"].includes(layer.title)) {
        layer.visible = (layer.title === layerTitle);
      }
    });

    const targetLayer = view.map.layers.find(l => l.title === layerTitle);
    if (!targetLayer) return;

    const query = targetLayer.createQuery();
    query.outFields = ["country", "trends"];
    query.where = "1=1";
    query.returnGeometry = false;

    targetLayer.queryFeatures(query).then((result) => {
      const features = result.features;
      const labels = [], data = [];
      features.forEach((f) => {
        const country = f.attributes.country;
        const trend = f.attributes.trends;
        if (trend > 0) {
          labels.push(country);
          data.push(trend);
        }
      });

      const canvas = document.getElementById("pieChart");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");

      if (window.pieChart && typeof window.pieChart.destroy === "function") {
        window.pieChart.destroy();
      }

      window.pieChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: labels.map((_, i) => `hsl(${i * 20 % 360}, 70%, 60%)`)
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: "white" } },
            title: {
              display: true,
              text: `${layerTitle.replace("Trends", "")} Global Search Share`,
              color: "#8a2be2",
              font: { size: 16 }
            }
          }
        }
      });
    });
  }

  // ‚ú® DOM Âä†ËΩΩÂêéËøõË°åÂàùÂßãÂåñ
  window.addEventListener("DOMContentLoaded", () => {
    loadWebMap("909ccff2f308451ca3d47aa968928a3b", [103.8, 1.35], 13);
  });
</script>
</body>
</html>
