<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Coffee Insight Map</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", sans-serif;
      background-color: #1f1f1f;
      color: white;
    }
    .container {
      display: flex;
      height: 100%;
    }
    #left-panel {
      width: 250px;
      background: #2a2a2a;
      padding: 16px;
    }
    #map {
      flex: 1;
      height: 100%;
    }
    #right-panel {
      width: 360px;
      background: #2a2a2a;
      padding: 16px;
      overflow-y: auto;
    }
    canvas {
      margin-top: 16px;
      background-color: #1f1f1f;
    }
    select, button {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #444;
      color: white;
    }
    .chart-title {
      font-size: 16px;
      color: #8a2be2;
      margin-top: 10px;
      margin-bottom: 4px;
    }
  </style>
</head>
  
<body>
  <div class="container">
    <div id="left-panel">
      <h2>‚òï Coffee Map</h2>
      <button onclick="loadWebMap('909ccff2f308451ca3d47aa968928a3b',[103.8, 1.35], 13)">Coffee Shop location in SG</button>
      <button onclick="loadWebMap('7a7a761019c744af8fe5a4315c3a1da2', [0, 20], 2)">Google Trends Map</button>
      <div id="trend-controls">
        <button onclick="showBrandTrends('StarbucksTrends')">Starbucks</button>
        <button onclick="showBrandTrends('TimsTrends')">Tim Hortons</button>
        <button onclick="showBrandTrends('LuckinTrends')">Luckin Coffee</button>
      </div>

    </div>
    <div id="map"></div>
    <div id="right-panel">
<div class="chart-title">üî• Global Search Trends</div>
<canvas id="pieChart" height="200"></canvas>

    </div>
  </div>

  <!-- ‚úÖ Âä†ËΩΩ Chart.jsÔºàUMDÁâàÊú¨Ôºâ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- ‚úÖ Âä†ËΩΩ ArcGIS JS API -->
  <script src="https://js.arcgis.com/4.28/"></script>

  <!-- ‚úÖ ÊâßË°åËÑöÊú¨ÔºöÁ≠âÈ°µÈù¢ÂÆåÂÖ®Âä†ËΩΩÂêéËøêË°å -->

  
  <script>
    let view;

// Âä†ËΩΩÂú∞Âõæ    
function loadWebMap(mapId, center = [0, 20], zoom = 2) {
  require(["esri/WebMap", "esri/views/MapView"], (WebMap, MapView) => {
    if (view) {
      view.container = null;
      view.destroy();
    }

    const webmap = new WebMap({
      portalItem: { id: mapId }
    });

    view = new MapView({
      container: "map",
      map: webmap,
      center: center,
      zoom: zoom
    });
    enablePopupToSidebar(view);
  });
}
    
//Âä†ËΩΩpopup window
    function enablePopupToSidebar(view) {
  const brandLinks = {
    "Starbucks": "https://www.starbucks.com/menu?_branch_match_id=1439859153515999594&utm_source=Web&utm_campaign=Pickup&utm_medium=marketing&_branch_referrer=H4sIAAAAAAAAA8soKSkottLXLy5JLEoqTc4u1kssKNDLyczL1g93LCkoD88J8zOxrytKTUstKsrMS49PKsovL04tsnXOKMrPTQUA%2BN1wVz8AAAA%3D",
    "Tiong Bahru Bakery": "https://www.tiongbahrubakery.com/takeaway-pre-order/",
    "Foreword Coffee": "https://forewordcoffee.com/?srsltid=AfmBOorymOOr41y--XQIlHwbjoFZOS1jeKXChmkzDfPFUsIYfpurqXZA",
    "Tim Hortons": "https://deliveroo.com.sg/menu/singapore/jurong-east-boon-lay-way/tim-hortons-jem?utm_source=google&utm_medium=cpc&utm_term=tim%20hortons%20delivery&utm_campaign=%2A%2A%5EAcquisition%5ESearch%5ERestaurant%5ESingapore%5EAll%20Cities%5ESGBJ%5EBroad%5EAPI%5EBukit%20Batok%20%26%20Jurong%20East%5E~1293~%5E%5EIndependents%5EEN%5ELifecycle%5E%C2%A322207624036&utm_loc=9062542&utm_device=c&utm_adposition=&utm_network=g&utm_targetid=kwd-319354228291&gclsrc=aw.ds&gad_source=1&gclid=CjwKCAjwwe2_BhBEEiwAM1I7sTGTTtzURCwIYCHPlCLL_YA4G38SYHIeKo-6W2OtYSNAz9fZ0kzK_BoCAlcQAvD_BwE",
    "Luckin Coffee": "https://www.luckincoffee.com/app/download",
    "Coffee Bean": "https://www.coffeebean.com/",
    "Ya Kun Kaya Toast": "https://app.yakun.com/cherish-app",
    "Ralph‚Äòs Coffee": "https://www.ralphlauren.com.sg/content-features/brand-navigation-categories/ralphs-coffee/ralphs-coffee?srsltid=AfmBOoqXhN49BoAqBdwsQfUiRWYbQQmRRpCeweFwFbXICvN0SLIopQ8V"
  };

  view.popup.autoOpenEnabled = false;

  view.on("click", function(event) {
    view.hitTest(event).then(function(response) {
      const result = response.results.find((res) =>
        res.graphic.layer.title === "Chain_CoffeeShop" ||
        res.graphic.layer.title === "independent_coffee_by_region"
      );

      if (result) {
        const attr = result.graphic.attributes;
        const brand = attr.Brand;
        const shopType = result.graphic.layer.title === "Chain_CoffeeShop"
          ? "Chain Coffee Shop"
          : "Independent Coffee Shop";
        const link = brandLinks[brand];

        // ÂàõÂª∫ÂÜÖÂÆπ HTML
        let html = `
          <div style="font-size: 15px; padding: 10px; line-height: 1.6;">
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">‚òï ${shopType}</div>
            <strong>Name:</strong> ${attr.Name}<br>
            <strong>Address:</strong> ${attr.Address}<br>
            <strong>Rating:</strong> ${attr.Rating} ‚≠ê<br><br>
        `;

        if (link) {
          const isApp = link.includes("app") || link.includes("download");
          const label = isApp ? "Download App to Order" : "Order Online";

          html += `
            <a href="${link}" target="_blank">
              <button style="
                background-color: #8a2be2;
                border: none;
                color: white;
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 14px;
                cursor: pointer;
              ">${label}</button>
            </a>
          `;
        }

        html += `</div>`;

        // ÊèíÂÖ•Âè≥‰æßÈù¢Êùø
        document.getElementById("right-panel").innerHTML = html;
      }
    });
  });
}

    
    //Âä†ËΩΩÊâáÂΩ¢ÂõæÂáΩÊï∞
    function showBrandTrends(layerTitle) {
  // ÊéßÂà∂ÂõæÂ±ÇÊòæÈöê
  view.map.layers.forEach((layer) => {
    if (["StarbucksTrends", "TimsTrends", "LuckinTrends"].includes(layer.title)) {
      layer.visible = (layer.title === layerTitle);
    }
  });

  // ÊèêÂèñËØ•ÂõæÂ±ÇÊâÄÊúâ features
  const targetLayer = view.map.layers.find(l => l.title === layerTitle);

  if (targetLayer) {
    const query = targetLayer.createQuery();
    query.outFields = ["country", "trends"];
    query.where = "1=1";
    query.returnGeometry = false;

    targetLayer.queryFeatures(query).then((result) => {
      const features = result.features;

      // Ê±áÊÄªÊï∞ÊçÆÔºö‰ª•ÂõΩÂÆ∂‰∏∫ labelÔºåtrends ‰∏∫ value
      const labels = [];
      const data = [];

      features.forEach((f) => {
        const country = f.attributes.country;
        const trend = f.attributes.trends;
        if (trend > 0) {
          labels.push(country);
          data.push(trend);
        }
      });

      // Ê∏ÖÈô§ÊóßÂõæË°®ÔºàÂ¶ÇÊûúÂ∑≤Â≠òÂú®Ôºâ
      if (window.pieChart) {
        window.pieChart.destroy();
      }

      // ÁªòÂà∂Êñ∞ÁöÑ Pie Chart
      const ctx = document.getElementById("pieChart").getContext("2d");
      window.pieChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: labels.map((_, i) => `hsl(${i * 20 % 360}, 70%, 60%)`)
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: "white" } },
            title: {
              display: true,
              text: `${layerTitle.replace("Trends", "")} Global Search Share`,
              color: "#8a2be2",
              font: { size: 16 }
            }
          }
        }
      });
    });
  }
}


    // ‰øùËØÅÈ°µÈù¢ DOM Âä†ËΩΩÂÆåÂÜçÊâßË°åÂõæË°®ÂàõÂª∫
    window.addEventListener("DOMContentLoaded", function () {
      loadWebMap("909ccff2f308451ca3d47aa968928a3b");

      const barCtx = document.getElementById("barChart").getContext("2d");
      const pieCtx = document.getElementById("pieChart").getContext("2d");

      new Chart(barCtx, {
        type: "bar",
        data: {
          labels: ["Starbucks", "Luckin", "Tim Hortons", "Costa", "McCafe"],
          datasets: [{
            label: "Èó®Â∫óÊï∞Èáè",
            backgroundColor: "#8a2be2",
            data: [32000, 11000, 8000, 5000, 3000]
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "white" } },
            y: { ticks: { color: "white" } }
          }
        }
      });

      new Chart(pieCtx, {
        type: "pie",
        data: {
          labels: ["Starbucks", "Luckin", "Tim Hortons", "Costa", "McCafe"],
          datasets: [{
            label: "Â∏ÇÂú∫Âç†ÊØî",
            data: [55, 20, 15, 5, 5],
            backgroundColor: [
              "#8a2be2", "#5cacee", "#ffa07a", "#20b2aa", "#ffcc00"
            ]
          }]
        },
        options: {
          plugins: { legend: { labels: { color: "white" } } }
        }
      });
    });
  </script>
</body>
</html>
