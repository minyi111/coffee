<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>‚òï Global Coffee Insight Map</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://js.arcgis.com/4.28/"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", sans-serif;
      background-color: #ffffff;
      color: #000000;
    }
    .container {
      display: flex;
      height: 100%;
    }
    #left-panel, #right-panel {
      background: #ffffff;
      padding: 16px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    #left-panel {
      width: 250px;
    }
    #right-panel {
      width: 360px;
      display: none;
    }
    #map {
      flex: 1;
      height: 100%;
    }
    canvas {
      margin-top: 16px;
      background-color: #ffffff;
    }
    select, button {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #f9f9f9;
      color: #000000;
    }
    .chart-title {
      font-size: 16px;
      color: #222222;
      margin-top: 10px;
      margin-bottom: 4px;
    }
    .legend {
      margin-top: 20px;
      font-size: 14px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
    }
    .legend-color {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      border-radius: 4px;
      display: inline-block;
    }
  </style>
</head>
<body>

<div class="container">
  <div id="left-panel">
    <button onclick="loadWebMap('909ccff2f308451ca3d47aa968928a3b',[103.8, 1.3521], 11)">Coffee Shop location in SG</button>
    <button onclick="loadWebMap('7a7a761019c744af8fe5a4315c3a1da2', [0, 20], 2)">Google Trends Map</button>

    <div id="trend-controls" style="margin-left: 12px; padding-left: 8px; border-left: 2px solid #ccc;">
      <p style="margin: 4px 0; font-size: 14px; color: #666;">‚Ü≥ Brand Trends:</p>
      <button onclick="toggleBrand('StarbucksTrends')">Starbucks</button>
      <button onclick="toggleBrand('TimsTrends')">Tim Hortons</button>
      <button onclick="toggleBrand('LuckinTrends')">Luckin Coffee</button>
    </div>
  </div>
  <div id="map"></div>
  <div id="right-panel"></div>
</div>
<script>
let view;
let activeLayerTitle = null;

function loadWebMap(mapId, center = [0, 20], zoom = 2) {
  require(["esri/WebMap", "esri/views/MapView"], (WebMap, MapView) => {
    if (view) {
      view.container = null;
      view.destroy();
    }
    const webmap = new WebMap({ portalItem: { id: mapId } });
    view = new MapView({ container: "map", map: webmap, center, zoom });
    enablePopupToSidebar(view);

    require(["esri/widgets/Legend"], (Legend) => {
      const legend = new Legend({ view: view });
      view.ui.add(legend, "manual");
      document.getElementById("left-panel").appendChild(legend.container);
    });

    require(["esri/widgets/ScaleBar", "esri/widgets/Compass"], (ScaleBar, Compass) => {
      const scaleBar = new ScaleBar({ view: view, unit: "metric" });
      view.ui.add(scaleBar, { position: "bottom-left" });
      const compass = new Compass({ view: view });
      view.ui.add(compass, "top-left");
    });
  });
}

function enablePopupToSidebar(view) {
  const brandLinks = {
    "Starbucks": "https://www.starbucks.com/menu?...",
    "Tiong Bahru Bakery": "https://www.tiongbahrubakery.com/takeaway-pre-order/",
    "Foreword Coffee": "https://forewordcoffee.com/...",
    "Tim Hortons": "https://deliveroo.com.sg/menu/...",
    "Luckin Coffee": "https://www.luckincoffee.com/app/download",
    "Coffee Bean": "https://www.coffeebean.com/",
    "Ya Kun Kaya Toast": "https://app.yakun.com/cherish-app",
    "Ralph‚Äòs Coffee": "https://www.ralphlauren.com.sg/..."
  };

  view.popup.autoOpenEnabled = false;

  view.on("click", (event) => {
    view.hitTest(event).then((response) => {
      const result = response.results.find(res =>
        res.graphic.layer.title === "Chain_CoffeeShop" ||
        res.graphic.layer.title === "independent_coffee_by_region"
      );
      if (result) {
        const layer = result.graphic.layer;
        const objectId = result.graphic.attributes[layer.objectIdField];
        const query = layer.createQuery();
        query.objectIds = [objectId];
        query.outFields = ["*"];
        layer.queryFeatures(query).then((res) => {
          const attr = res.features[0].attributes;
          const name = attr.Name || attr.name || "(no name)";
          const address = attr.Address || attr.address || "(no address)";
          const rating = attr.Rating || attr.rating || "N/A";
          const brand = attr.Brand || attr.brand || "Unknown";
          const link = brandLinks[brand];

          let html = `
            <div style="font-size:16px; padding:14px; line-height:1.8;">
            <div style="font-size:20px; font-weight:bold; color:#333; margin-bottom:8px;">${name}</div>
            <div><strong style="color:#555;">üìç Address:</strong><br>${address}</div>
            <div style="margin-top:8px;">
            <strong style="color:#555;">‚≠ê Google Rating:</strong> 
            <span style="display:inline-block; font-size:16px; background:#f4f4f4; padding:2px 8px; border-radius:6px; margin-left:6px;">
            ${rating} / 5</span>
        </div>`;

          if (link) {
            const isApp = link.includes("app") || link.includes("download");
            const label = isApp ? "Download App to Order" : "Order Online";
            html += `<a href="${link}" target="_blank">
              <button style="background-color:#8a2be2;border:none;color:white;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">
                ${label}
              </button>
            </a>`;
          }

          html += `</div>`;

          const panel = document.getElementById("right-panel");
          panel.innerHTML = `
            <button onclick="hideRightPanel()" style="
              background-color: #ccc;
              border: none;
              color: #000;
              padding: 6px 12px;
              border-radius: 6px;
              font-size: 13px;
              float: right;
              cursor: pointer;
              margin-bottom: 8px;">Hide</button>
            ${html}`;

          panel.style.display = "block";
        });
      }
    });
  });
}

function toggleBrand(layerTitle) {
  if (!view) return;
  view.map.layers.forEach(layer => {
    if (["StarbucksTrends", "TimsTrends", "LuckinTrends"].includes(layer.title)) {
      layer.visible = (layer.title === layerTitle);
    }
  });
  showBrandTrends(layerTitle);
}

function showBrandTrends(brand) {
  const dataMap = {
    "StarbucksTrends": {
      labels: ["United States", "Canada", "Singapore", "Philippines", "Malaysia"],
      data: [100, 85, 78, 52, 50]
    },
    "TimsTrends": {
      labels: ["Canada", "United Arab Emirates", "United Kingdom", "Philippines", "Pakistan"],
      data: [100, 6, 5, 3, 3]
    },
    "LuckinTrends": {
      labels: ["Singapore", "China", "Malaysia", "Switzerland", "Germany"],
      data: [100, 40, 12, 6, 4]
    }
  };

  const brandColors = {
      "StarbucksTrends": ["#aab6ec", "#fdd8a8", "#c7e3cb", "#ead6d7", "#d7d3d2"],
      "TimsTrends": ["#aab6ec", "#fdd8a8", "#c7e3cb", "#ead6d7", "#d7d3d2"],
      "LuckinTrends": ["#aab6ec", "#fdd8a8", "#c7e3cb", "#ead6d7", "#d7d3d2"]
  };


  const brandData = dataMap[brand];
  if (!brandData) return;

  const panel = document.getElementById("right-panel");
  panel.style.display = "block";
  panel.innerHTML = `
    <div class="chart-title">Global Search Trends</div>
    <canvas id="pieChart" height="200"></canvas>`;

  const ctx = document.getElementById("pieChart").getContext("2d");
  if (window.pieChart && typeof window.pieChart.destroy === "function") {
    window.pieChart.destroy();
  }

  window.pieChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: brandData.labels,
      datasets: [{
        data: brandData.data,
        backgroundColor: Array(brandData.labels.length).fill(brandColors[brand])
      }]
    },
    options: {
      plugins: {
        legend: { labels: { color: "#000" } },
        title: {
          display: true,
          text: brand.replace("Trends", "") + " Global Search Share",
          color: "#000",
          font: { size: 16 }
        }
      }
    }
  });
}

function hideRightPanel() {
  const panel = document.getElementById("right-panel");
  panel.style.display = "none";
}

window.addEventListener("DOMContentLoaded", () => {
  loadWebMap("909ccff2f308451ca3d47aa968928a3b", [103.8, 1.3521], 11);
});
</script>
</body>
</html>
