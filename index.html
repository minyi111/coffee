<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Coffee Insight Map</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/dark/main.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Segoe UI", sans-serif;
      background-color: #1f1f1f;
      color: white;
    }
    .container {
      display: flex;
      height: 100%;
    }
    #left-panel {
      width: 250px;
      background: #2a2a2a;
      padding: 16px;
    }
    #map {
      flex: 1;
      height: 100%;
    }
    #right-panel {
      width: 360px;
      background: #2a2a2a;
      padding: 16px;
      overflow-y: auto;
    }
    canvas {
      margin-top: 16px;
      background-color: #1f1f1f;
    }
    select, button {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #444;
      color: white;
    }
    .chart-title {
      font-size: 16px;
      color: #8a2be2;
      margin-top: 10px;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="left-panel">
      <h2>☕ Coffee Map</h2>
      <button onclick="loadWebMap('909ccff2f308451ca3d47aa968928a3b')">店铺位置地图</button>
      <button onclick="loadWebMap('7a7a761019c744af8fe5a4315c3a1da2')">Google Trends 地图</button>
    </div>
    <div id="map"></div>
    <div id="right-panel">
      <div class="chart-title">📊 门店数量 Top 5</div>
      <canvas id="barChart" height="180"></canvas>
      <div class="chart-title">🌍 品牌全球占比</div>
      <canvas id="pieChart" height="200"></canvas>
    </div>
  </div>

  <!-- ✅ 加载 Chart.js（UMD版本） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- ✅ 加载 ArcGIS JS API -->
  <script src="https://js.arcgis.com/4.28/"></script>

  <!-- ✅ 执行脚本：等页面完全加载后运行 -->
  <script>
    let view;

    function loadWebMap(mapId) {
      require(["esri/WebMap", "esri/views/MapView"], (WebMap, MapView) => {
        if (view) {
          view.container = null;
          view.destroy();
        }
        const webmap = new WebMap({
          portalItem: { id: mapId }
        });

        view = new MapView({
          container: "map",
          map: webmap,
          center: [0, 20],
          zoom: 2
        });
      });
    }

    // 保证页面 DOM 加载完再执行图表创建
    window.addEventListener("DOMContentLoaded", function () {
      loadWebMap("909ccff2f308451ca3d47aa968928a3b");

      const barCtx = document.getElementById("barChart").getContext("2d");
      const pieCtx = document.getElementById("pieChart").getContext("2d");

      new Chart(barCtx, {
        type: "bar",
        data: {
          labels: ["Starbucks", "Luckin", "Tim Hortons", "Costa", "McCafe"],
          datasets: [{
            label: "门店数量",
            backgroundColor: "#8a2be2",
            data: [32000, 11000, 8000, 5000, 3000]
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: "white" } },
            y: { ticks: { color: "white" } }
          }
        }
      });

      new Chart(pieCtx, {
        type: "pie",
        data: {
          labels: ["Starbucks", "Luckin", "Tim Hortons", "Costa", "McCafe"],
          datasets: [{
            label: "市场占比",
            data: [55, 20, 15, 5, 5],
            backgroundColor: [
              "#8a2be2", "#5cacee", "#ffa07a", "#20b2aa", "#ffcc00"
            ]
          }]
        },
        options: {
          plugins: { legend: { labels: { color: "white" } } }
        }
      });
    });
  </script>
</body>
</html>
